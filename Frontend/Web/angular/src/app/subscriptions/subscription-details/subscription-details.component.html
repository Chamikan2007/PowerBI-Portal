<section class="content">
    <div class="content-block">
        <div class="row clearfix">
            <div class="col col-12">
                <div class="card">
                    <div class="header">
                        <div class="w-100 d-flex justify-content-between">
                            <h2>Subscription Details</h2>
                            <button class="icon-button" (click)="goBack()">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                    <div class="body">
                        <form class="validate-form" [formGroup]="subscriptionForm" (ngSubmit)="onSubmit()">
                            <div class="row mb-5">
                                <div class="col col-4 border rounded py-3 px-5">
                                    <div class="row">
                                        <mat-form-field class="example-full-width" appearance="outline">
                                            <mat-label>Report</mat-label>
                                            <input type="text" class="form-control" placeholder="Pick a report" aria-label="Report" matInput [formControl]="reportPicker" [matAutocomplete]="auto">
                                            <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete" (optionSelected)='setSelectedReport($event.option)'>
                                                @for (report of filteredReports | async; track report) {
                                                <mat-option [value]="report.path">{{report.path}}</mat-option>
                                                }
                                            </mat-autocomplete>
                                            <!-- @if (subscriptionForm.get('reportPicker')?.hasError('required')) {
                                            <mat-error>
                                                Report is required.
                                            </mat-error>
                                            } -->
                                        </mat-form-field>
                                    </div>

                                    <div class="row">
                                        <div class="col col-12 mb-2">
                                            <mat-form-field class="example-full-width" appearance="outline">
                                                <mat-label>Description</mat-label>
                                                <input matInput type="text" formControlName="description" class="form-control" (change)="onDescriptionChange($event)">
                                                <!-- @if (subscriptionForm.get('description')?.hasError('required')) {
                                                <mat-error>
                                                    Description is required.
                                                </mat-error>
                                                } -->
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col col-12 mb-2">
                                            <mat-form-field class="example-full-width" appearance="outline">
                                                <mat-label>Owner</mat-label>
                                                <input matInput type="text" formControlName="owner" class="form-control">
                                                <!-- @if (subscriptionForm.get('owner')?.hasError('required')) {
                                                <mat-error>
                                                    Owner is required.
                                                </mat-error>
                                                } -->
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <h5 class="mt-5">Subscription type</h5>
                                    </div>
                                    <div class="row">
                                        <div class="col col-12 mb-5">
                                            <mat-radio-group class="vertical-radio-group" formControlName="subscriptionType" (change)="onSubscriptionTypeChange($event)">
                                                <mat-radio-button value="1" checked>Standard subscription</mat-radio-button>
                                                <mat-radio-button value="2" [disabled]="true">Data-driven subscription</mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <h5 class="mt-5">Destination</h5>
                                    </div>
                                    <div class="row">
                                        <div class="col col-12">
                                            <mat-form-field>
                                                <mat-select formControlName="destinationType" (selectionChange)="onDestinationChange($event)">
                                                    <mat-option *ngFor="let opt of destinationItems; index as i;" [value]="opt.key" [disabled]="i==0">{{opt.value}}</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <div *ngIf="model.destination == 2" class="row">
                                        <h5 class="mt-5">Delivery options (Email)</h5>
                                        <div class="row">
                                            <div class="col col-12 mb-2">
                                                <mat-form-field class="example-full-width" appearance="outline">
                                                    <mat-label>To</mat-label>
                                                    <input matInput type="email" formControlName="email_to" class="form-control" (change)="onDeliveryOptionEmailToChange($event)">
                                                    <!-- @if (subscriptionForm.get('email_to')?.hasError('required, email')) {
                                                    <mat-error>
                                                        To email is required.
                                                    </mat-error>
                                                    } -->
                                                </mat-form-field>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col col-12 mb-2">
                                                <mat-form-field class="example-full-width" appearance="outline">
                                                    <mat-label>Cc</mat-label>
                                                    <input matInput type="email" formControlName="email_cc" class="form-control" (change)="onDeliveryOptionEmailCcChange($event)">
                                                    <!-- @if (subscriptionForm.get('email_cc')?.hasError('email')) {
                                                    <mat-error>
                                                        Cc email is invalid.
                                                    </mat-error>
                                                    } -->
                                                </mat-form-field>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col col-12 mb-2">
                                                <mat-form-field class="example-full-width" appearance="outline">
                                                    <mat-label>Bcc</mat-label>
                                                    <input matInput type="email" formControlName="email_bcc" class="form-control" (change)="onDeliveryOptionEmailBccChange($event)">
                                                    <!-- @if (subscriptionForm.get('email_bcc')?.hasError('email')) {
                                                    <mat-error>
                                                        Bcc email is invalid.
                                                    </mat-error>
                                                    } -->
                                                </mat-form-field>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col col-12 mb-2">
                                                <mat-form-field class="example-full-width" appearance="outline">
                                                    <mat-label>Reply To</mat-label>
                                                    <input matInput type="email" formControlName="email_replyto" class="form-control" (change)="onDeliveryOptionEmailReplyToChange($event)">
                                                    <!-- @if (subscriptionForm.get('email_replyto')?.hasError('email')) {
                                                    <mat-error>
                                                        Reply To email is invalid.
                                                    </mat-error>
                                                    } -->
                                                </mat-form-field>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col col-12 mb-2">
                                                <mat-form-field class="example-full-width" appearance="outline">
                                                    <mat-label>Subject</mat-label>
                                                    <input matInput type="text" formControlName="email_subject" class="form-control" (change)="onDeliveryOptionEmailSubjectChange($event)">
                                                    <!-- @if (subscriptionForm.get('email_subject')?.hasError('required')) {
                                                    <mat-error>
                                                        Subject is required.
                                                    </mat-error>
                                                    } -->
                                                </mat-form-field>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col col-6">
                                                <mat-checkbox value="1" formControlName="includeReportCheckbox" checked (change)="onIncludeReportChange($event.checked)">Include Report</mat-checkbox>
                                                <mat-checkbox value="2" formControlName="includeLinkCheckbox" checked (change)="onIncludeLinkChange($event.checked)">Include Link</mat-checkbox>
                                            </div>
                                            <div class="col col-6">
                                                <mat-form-field>
                                                    <mat-label>Render Format</mat-label>
                                                    <mat-select formControlName="renderFormat" (selectionChange)="onRenderFormatChange($event)">
                                                        <mat-option *ngFor="let opt of renderFormatItems;" [value]="opt.key">{{opt.value}}</mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col col-6">
                                                <mat-form-field>
                                                    <mat-label>Priority</mat-label>
                                                    <mat-select formControlName="priority" (selectionChange)="onPriorityChange($event)">
                                                        <mat-option *ngFor="let opt of priorityItems;" [value]="opt.key">{{opt.value}}</mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <mat-form-field>
                                                <mat-label>Comment</mat-label>
                                                <textarea matInput formControlName="comment" class="form-control" (change)="onCommentTextChange($event)"></textarea>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>

                                <div class="col col-auto"></div>

                                <div class="col col-5  border rounded py-3 px-5">
                                    <div class="row">
                                        <h5>Schedule details</h5>
                                    </div>
                                    <div class="row">
                                        <div class="col col-12 mb-5">
                                            <mat-radio-group class="vertical-radio-group" formControlName="scheduleDetailType" (change)="onScheduleDetailTypeChange($event)">
                                                <mat-radio-button value="1" [disabled]="true">Shared schedule</mat-radio-button>
                                                <mat-radio-button value="2" checked>Report-specific schedule</mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                    </div>
                                    <hr>
                                    <div *ngIf="model.scheduleDetailType == 2" class="row">
                                        <div class="col col-12 mb-5">
                                            <mat-radio-group formControlName="scheduleType" (change)="onScheduleTypeChange($event)">
                                                <mat-radio-button *ngFor="let opt of scheduleTypeItems; index as i" [value]="opt.key" [checked]="i==0" class="me-4">{{opt.value}}</mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div [ngSwitch]="model.scheduleType" class="mt-5">
                                            <div *ngSwitchCase="1" class="row">
                                                <div>
                                                    <h5>Hourly schedule</h5>
                                                    <label>Run the schedule every:</label>
                                                    <div class="row d-flex">
                                                        <div class="col col-auto pe-1">
                                                            <mat-form-field class="example-full-width number-input" appearance="outline">
                                                                <input type="number" class="form-control" matInput formControlName="hourly_hour" (change)="onHourlyRunScheduleEveryHourChange($event)">
                                                            </mat-form-field>
                                                        </div>
                                                        <div class="col col-auto ps-1">
                                                            <label class="time-label">hours</label>
                                                        </div>
                                                        <div class="col col-auto pe-1">
                                                            <mat-form-field class="example-full-width number-input" appearance="outline">
                                                                <input type="number" class="form-control" matInput formControlName="hourly_minute" (change)="onHourlyRunScheduleEveryMinuteChange($event)">
                                                            </mat-form-field>
                                                        </div>
                                                        <div class="col col-auto ps-1">
                                                            <label class="time-label">minutes</label>
                                                        </div>
                                                    </div>
                                                    <div class="row d-flex mt-4">
                                                        <div class="col col-auto">
                                                            <label class="time-label">Start time</label>
                                                        </div>
                                                        <div class="col col-auto">
                                                            <mat-form-field class="example-full-width number-input" appearance="outline">
                                                                <input type="number" class="form-control" matInput formControlName="hourly_start_hour">
                                                            </mat-form-field>
                                                        </div>
                                                        <div class="col col-auto">
                                                            <mat-form-field class="example-full-width number-input" appearance="outline">
                                                                <input type="number" class="form-control" matInput formControlName="hourly_start_minute">
                                                            </mat-form-field>
                                                        </div>
                                                        <div class="col col-auto ps-1">
                                                            <mat-button-toggle-group name="meridiem" class="mt-4" formControlName="hourly_start_meridiem">
                                                                <mat-button-toggle value="1" (change)="onHourlyMeridiemChange($event)">AM</mat-button-toggle>
                                                                <mat-button-toggle value="2" (change)="onHourlyMeridiemChange($event)">PM</mat-button-toggle>
                                                            </mat-button-toggle-group>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngSwitchCase="2" class="row">
                                                <h5>Daily schedule</h5>
                                                <div class="row">
                                                    <mat-radio-group class="vertical-radio-group" formControlName="dailyScheduleType" (change)="onDailyScheduleTypeChange($event)">
                                                        <mat-radio-button value="1" checked>On the following days:</mat-radio-button>
                                                        <div class="ms-3">
                                                            <mat-checkbox *ngFor="let opt of daysOfWeekItems;" [value]="opt.key" [checked]="true" [disabled]="model.scheduleDetail.dailyScheduleType != 1" class="mb-2"
                                                                (change)="onDailyScheduleDayStatusChange($event.checked, opt)">
                                                                {{opt.value}}</mat-checkbox>
                                                        </div>
                                                        <mat-radio-button value="2">Every weekday</mat-radio-button>
                                                        <mat-radio-button value="3">
                                                            <div class="row d-flex">
                                                                <div class="col col-auto ms-0 ps-0">
                                                                    <label class="mt-4">Repeat after this number of days:</label>
                                                                </div>
                                                                <div class="col col-auto">
                                                                    <mat-form-field class="example-full-width number-input" appearance="outline">
                                                                        <!-- formControlName="daily_after_days_count" -->
                                                                        <input type="number" class="form-control" matInput [disabled]="model.scheduleDetail.dailyScheduleType !== 3" (change)="onDailyRunScheduleRepeatAfterDayCountChange($event)">
                                                                    </mat-form-field>
                                                                </div>
                                                            </div>
                                                        </mat-radio-button>
                                                    </mat-radio-group>
                                                </div>
                                                <div class="row d-flex mt-4">
                                                    <div class="col col-auto">
                                                        <label class="time-label">Start time</label>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="daily_start_hour" (change)="onDailyRunScheduleStartHourChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="daily_start_minute" (change)="onDailyRunScheduleStartMinuteChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto ps-1">
                                                        <mat-button-toggle-group name="meridiem" class="mt-4" formControlName="daily_start_meridiem">
                                                            <mat-button-toggle value="1" (change)="onDailyMeridiemChange($event)">AM</mat-button-toggle>
                                                            <mat-button-toggle value="2" (change)="onDailyMeridiemChange($event)">PM</mat-button-toggle>
                                                        </mat-button-toggle-group>
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngSwitchCase="3" class="row">
                                                <h5>Weekly schedule</h5>
                                                <div class="row d-flex">
                                                    <div class="col col-auto ms-0 ps-0">
                                                        <label class="time-label">Repeat after this number of days:</label>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput (change)="onWeeklyRunScheduleRepeatAfterDayCountChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                </div>
                                                <div class="row pt-3">
                                                    <div class="ms-3">
                                                        <mat-checkbox *ngFor="let opt of daysOfWeekItems;" [value]="opt.key" [checked]="true" class="mb-2" (change)="onWeeklyScheduleDayStatusChange($event.checked, opt)">{{opt.value}}</mat-checkbox>
                                                    </div>
                                                </div>
                                                <div class="row d-flex mt-4">
                                                    <div class="col col-auto">
                                                        <label class="time-label">Start time</label>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="weekly_start_hour" (change)="onWeeklyRunScheduleStartHourChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="weekly_start_minute" (change)="onWeeklyRunScheduleStartMinuteChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto ps-1">
                                                        <mat-button-toggle-group name="meridiem" class="mt-4" formControlName="weekly_start_meridiem">
                                                            <mat-button-toggle value="1" (change)="onWeeklyMeridiemChange($event)">AM</mat-button-toggle>
                                                            <mat-button-toggle value="2" (change)="onWeeklyMeridiemChange($event)">PM</mat-button-toggle>
                                                        </mat-button-toggle-group>
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngSwitchCase="4" class="row">
                                                <h5>Monthly schedule</h5>
                                                <div class="row">
                                                    <label>Months:</label>
                                                    <div class="ms-3">
                                                        <mat-checkbox *ngFor="let opt of monthsOfYearItems;" [value]="opt.key" [checked]="true" class="mb-2" (change)="onMonthlyScheduleMonthStatusChange($event.checked, opt)">{{opt.value}}
                                                        </mat-checkbox>
                                                    </div>
                                                </div>
                                                <div class="row pt-3">
                                                    <mat-radio-group class="vertical-radio-group" formControlName="monthlyScheduleType" (change)="onMonthlyScheduleTypeChange($event)">
                                                        <mat-radio-button value="1" checked>On week of month:</mat-radio-button>
                                                        <div class="ms-3">
                                                            <mat-form-field>
                                                                <mat-select [disabled]="model.scheduleDetail.monthlyScheduleType != 1" (selectionChange)="onMonthlyScheduleWeekOfMonthChange($event)">
                                                                    <mat-option *ngFor="let opt of weekOfMonthItems;" [value]="opt.key">{{opt.value}}</mat-option>
                                                                </mat-select>
                                                            </mat-form-field>
                                                            <div class="mt-3">
                                                                <div class="row">
                                                                    <label>On days of week:</label>
                                                                </div>
                                                                <mat-checkbox *ngFor="let opt of daysOfWeekItems;" [value]="opt.key" [checked]="true" class="mb-2" [disabled]="model.scheduleDetail.monthlyScheduleType != 1"
                                                                    (change)="onMonthlyScheduleOnDayOfWeekChange($event.checked, opt)">{{opt.value}}
                                                                </mat-checkbox>
                                                            </div>
                                                        </div>
                                                        <mat-radio-button value="2">
                                                            <div class="row d-flex">
                                                                <div class="col col-auto ms-0 ps-0">
                                                                    <label class="mt-4">On calendar day(s):</label>
                                                                </div>
                                                                <div class="col col-auto">
                                                                    <mat-form-field class="example-full-width" appearance="outline">
                                                                        <input type="text" class="form-control" matInput [disabled]="model.scheduleDetail.monthlyScheduleType != 2" (change)="onMonthlyScheduleOnCalendarDaysChange($event)">
                                                                    </mat-form-field>
                                                                </div>
                                                            </div>
                                                        </mat-radio-button>
                                                    </mat-radio-group>
                                                </div>
                                                <div class="row d-flex mt-4">
                                                    <div class="col col-auto">
                                                        <label class="time-label">Start time</label>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="monthly_start_hour" (change)="onMonthlyRunScheduleStartHourChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="monthly_start_minute" (change)="onMonthlyRunScheduleStartMinuteChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto ps-1">
                                                        <mat-button-toggle-group name="meridiem" class="mt-4" formControlName="monthly_start_meridiem">
                                                            <mat-button-toggle value="1" (change)="onMonthlyMeridiemChange($event)">AM</mat-button-toggle>
                                                            <mat-button-toggle value="2" (change)="onMonthlyMeridiemChange($event)">PM</mat-button-toggle>
                                                        </mat-button-toggle-group>
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngSwitchCase="5" class="row">
                                                <h5>Once-time schedule</h5>
                                                <div class="row d-flex mt-4">
                                                    <div class="col col-auto">
                                                        <label class="time-label">Start time</label>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="monthly_start_hour" (change)="onOneTimeRunScheduleStartHourChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto">
                                                        <mat-form-field class="example-full-width number-input" appearance="outline">
                                                            <input type="number" class="form-control" matInput formControlName="monthly_start_minute" (change)="onOneTimeRunScheduleStartMinuteChange($event)">
                                                        </mat-form-field>
                                                    </div>
                                                    <div class="col col-auto ps-1">
                                                        <mat-button-toggle-group name="meridiem" class="mt-4" formControlName="onetime_start_meridiem">
                                                            <mat-button-toggle value="1" (change)="onOneTimeMeridiemChange($event)">AM</mat-button-toggle>
                                                            <mat-button-toggle value="2" (change)="onOneTimeMeridiemChange($event)">PM</mat-button-toggle>
                                                        </mat-button-toggle-group>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <hr class="mt-5">
                                        <div class="row">
                                            <h5 class="mt-5">Start and end dates</h5>
                                            <label>Begin running this schedule on:</label>
                                            <div class="row ">
                                                <div class="col col-5">
                                                    <mat-form-field class="example-full-width">
                                                        <input matInput [matDatepicker]="hourly_picker_start" formControlName="hourly_start_date" (dateChange)="onStartDateChange($event)" />
                                                        <mat-hint>YYYY/MM/DD</mat-hint>
                                                        <mat-datepicker-toggle matIconSuffix [for]="hourly_picker_start"></mat-datepicker-toggle>
                                                        <mat-datepicker #hourly_picker_start></mat-datepicker>
                                                    </mat-form-field>
                                                </div>
                                            </div>
                                            <div class="row ">
                                                <div class="col col-5">
                                                    <mat-checkbox value="1" [disabled]="true" class="mt-4">Stop this schedule on:</mat-checkbox>
                                                    <mat-form-field class="example-full-width mt-0">
                                                        <!-- formControlName="hourly_end_date" -->
                                                        <input matInput [matDatepicker]="hourly_picker_end" [disabled]="true" />
                                                        <mat-hint>YYYY/MM/DD</mat-hint>
                                                        <mat-datepicker-toggle matIconSuffix [for]="hourly_picker_end"></mat-datepicker-toggle>
                                                        <mat-datepicker #hourly_picker_end></mat-datepicker>
                                                    </mat-form-field>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            @if (error) {
                            <div class="alert alert-danger mt-3 mb-0">{{error}}</div>
                            }
                            <div class="me-4 text-end">
                                <button mat-button color="accent" class="btn" type="button" (click)="onCancel()">Cancel</button>
                                <button mat-flat-button color="accent" [class.auth-spinner]="loading" [disabled]="loading" class="btn ms-2" type="submit">Submit</button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>